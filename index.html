<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Game of Freedom ‚Äî Sifu Mode (v1.3 Sticky Journal)</title>
  <style>
    :root{
      --text:#e7f0ff;
      --muted:#a7b4c7;
      --accent:#7cf7c2;
      --warn:#ffd166;
      --bad:#ff5c7c;
      --good:#7cf7c2;
      --line:#263246;
      --chip:#162236;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --px: 2px;

      /* Category theme (same color inside same category) */
      --cat-qi-bg:    rgba(124,247,194,.10);
      --cat-qi-br:    rgba(124,247,194,.35);

      --cat-system-bg:rgba(255,209,102,.10);
      --cat-system-br:rgba(255,209,102,.35);

      --cat-lib-bg:   rgba(124,170,255,.10);
      --cat-lib-br:   rgba(124,170,255,.35);

      --cat-resp-bg:  rgba(140,255,190,.10);
      --cat-resp-br:  rgba(140,255,190,.35);

      --cat-dev-bg:   rgba(255,214,165,.10);
      --cat-dev-br:   rgba(255,214,165,.35);

      --cat-eff-bg:   rgba(255,92,124,.10);
      --cat-eff-br:   rgba(255,92,124,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(124,247,194,.10), transparent 60%),
        radial-gradient(900px 600px at 90% 20%, rgba(255,209,102,.08), transparent 55%),
        linear-gradient(180deg, #070a0f, #0b0f14 55%, #070a0f);
      color:var(--text);
      font-family: ui-monospace, Menlo, Monaco, Consolas, "Courier New", monospace;
      letter-spacing:.2px;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px 14px 40px}

    .topbar{
      display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      padding:14px;border:var(--px) solid var(--line);background:rgba(16,24,38,.85);box-shadow:var(--shadow)
    }
    .brand{display:flex;gap:12px;align-items:flex-start}
    .logo{
      width:44px;height:44px;border:var(--px) solid var(--line);background:linear-gradient(180deg,#0f1c2e,#0a1220);
      display:grid;place-items:center;
      box-shadow: inset 0 0 0 2px rgba(124,247,194,.08);
    }
    .brand h1{font-size:14px;margin:0;line-height:1.2}
    .brand p{margin:3px 0 0;color:var(--muted);font-size:12px}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .chip{
      display:flex;gap:8px;align-items:center;
      padding:8px 10px;border:var(--px) solid var(--line);background:var(--chip)
    }
    input[type="date"], input[type="month"], select{
      background:#0b1422;color:var(--text);border:var(--px) solid var(--line);padding:6px 8px;
      font-family:inherit
    }
    button{
      cursor:pointer;
      background:linear-gradient(180deg,#1a2a44,#0f1a2b);
      color:var(--text);
      border:var(--px) solid var(--line);
      padding:8px 10px;
      font-family:inherit;
      text-transform:uppercase;
      font-size:12px;
      letter-spacing:.6px;
    }
    button:hover{border-color:rgba(124,247,194,.55)}
    button:disabled{opacity:.5;cursor:not-allowed}

    /* ===== Sticky Journal du Jour ===== */
    .leftSticky{
      position: sticky;
      top: 12px;                 /* distance from top of viewport */
      align-self: start;         /* important for grid */
      z-index: 50;
    }
    /* Prevent sticky from touching topbar on small screens */
    @media (max-width: 980px){
      .leftSticky{ position: static; top:auto; z-index:auto; }
    }
    /* ================================= */

    .grid{display:grid;grid-template-columns: 1.15fr .85fr;gap:14px;margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .panel{
      border:var(--px) solid var(--line);
      background:rgba(16,24,38,.75);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:10px 12px;border-bottom:var(--px) solid var(--line);
      background:linear-gradient(180deg, rgba(124,247,194,.10), rgba(0,0,0,0));
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      flex-wrap:wrap;
    }
    .panel .hd h2{margin:0;font-size:12px;letter-spacing:.9px;text-transform:uppercase}
    .panel .bd{padding:12px}

    .kpis{display:grid;grid-template-columns: repeat(4, 1fr);gap:10px}
    @media (max-width: 640px){ .kpis{grid-template-columns: repeat(2,1fr)} }
    .kpi{padding:10px;border:var(--px) solid var(--line);background:rgba(15,22,34,.8)}
    .kpi .label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.7px}
    .kpi .value{font-size:18px;margin-top:6px}
    .bar{
      height:10px;border:var(--px) solid var(--line);background:#0a1220;margin-top:8px;
      position:relative;overflow:hidden
    }
    .bar > span{
      position:absolute;left:0;top:0;height:100%;width:0%;
      background:linear-gradient(90deg, rgba(124,247,194,.95), rgba(255,209,102,.85));
    }
    .status{margin-top:8px;font-size:12px;color:var(--muted);line-height:1.35}
    .status b.ok{color:var(--good)}
    .status b.no{color:var(--bad)}

    .badge{
      padding:2px 6px;border:var(--px) solid var(--line);background:rgba(22,34,54,.85);
      color:var(--text);font-size:11px;white-space:nowrap
    }
    .pill{
      display:inline-block;padding:2px 6px;border:var(--px) solid var(--line);background:rgba(22,34,54,.85);
      color:var(--text);font-size:11px;margin-left:6px
    }
    .divider{height:1px;background:var(--line);margin:12px 0}
    .footnote{margin-top:10px;font-size:12px;color:var(--muted)}
    .blink{animation: blink 1.2s steps(2, jump-none) infinite;color:var(--accent)}
    @keyframes blink{50%{opacity:.35}}

    /* Tasks (base) */
    .task{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      padding:10px;border:var(--px) solid var(--line);
      background:rgba(15,22,34,.75);
      margin-bottom:8px;
    }
    .task .left{display:flex;gap:10px;align-items:flex-start}
    .task label{cursor:pointer}
    .task .meta{color:var(--muted);font-size:12px;margin-top:2px}
    .xp{
      display:flex;gap:8px;align-items:center;white-space:nowrap;
      color:var(--accent);font-size:12px
    }
    .xp small{color:var(--muted)}

    /* Category colors */
    .cat-qi{     background:linear-gradient(180deg,var(--cat-qi-bg), rgba(10,18,32,.55)); border-color:var(--cat-qi-br); }
    .cat-system{ background:linear-gradient(180deg,var(--cat-system-bg), rgba(10,18,32,.55)); border-color:var(--cat-system-br); }
    .cat-lib{    background:linear-gradient(180deg,var(--cat-lib-bg), rgba(10,18,32,.55)); border-color:var(--cat-lib-br); }
    .cat-resp{   background:linear-gradient(180deg,var(--cat-resp-bg), rgba(10,18,32,.55)); border-color:var(--cat-resp-br); }
    .cat-dev{    background:linear-gradient(180deg,var(--cat-dev-bg), rgba(10,18,32,.55)); border-color:var(--cat-dev-br); }
    .cat-eff{    background:linear-gradient(180deg,var(--cat-eff-bg), rgba(10,18,32,.55)); border-color:var(--cat-eff-br); }

    /* Rewards */
    .rewards{display:grid;gap:10px}
    .reward{
      padding:10px;border:var(--px) solid var(--line);background:rgba(15,22,34,.75);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .reward .name{font-size:12px}
    .reward .cost{font-size:12px;color:var(--warn)}
    .reward .hint{font-size:11px;color:var(--muted);margin-top:3px}
    .reward .right{display:flex;gap:8px;align-items:center;white-space:nowrap}

    .log{
      max-height:200px;overflow:auto;border:var(--px) solid var(--line);background:rgba(10,18,32,.6);
      padding:10px;font-size:12px;color:var(--muted)
    }
    .log .item{padding:6px 0;border-bottom:1px dashed rgba(38,50,70,.7)}
    .log .item:last-child{border-bottom:none}

    /* History */
    .historyControls{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      margin-bottom:10px
    }
    .historyControls .left, .historyControls .right{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center
    }
    .summaryGrid{
      display:grid;grid-template-columns: repeat(3, 1fr);gap:8px;margin-bottom:10px
    }
    @media (max-width: 640px){ .summaryGrid{grid-template-columns:1fr} }
    .sumCard{
      padding:10px;border:var(--px) solid var(--line);background:rgba(15,22,34,.8)
    }
    .sumCard .t{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.7px}
    .sumCard .v{font-size:16px;margin-top:6px}
    .tableWrap{
      border:var(--px) solid var(--line);
      background:rgba(10,18,32,.55);
      overflow:auto;
      max-height:320px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      min-width:980px;
    }
    th, td{
      padding:8px 10px;
      border-bottom:1px dashed rgba(38,50,70,.7);
      vertical-align:top;
      white-space:nowrap;
    }
    th{
      text-transform:uppercase;
      letter-spacing:.6px;
      font-size:11px;
      color:var(--muted);
      background:rgba(15,22,34,.75);
      position:sticky; top:0;
    }
    tr:hover td{background:rgba(124,247,194,.06)}
    .linkBtn{
      background:transparent;
      border:var(--px) solid var(--line);
      padding:6px 8px;
      font-size:11px;
    }
    .linkBtn:hover{border-color:rgba(124,247,194,.55)}

    /* Collapsible sections */
    details.section{
      border:var(--px) solid var(--line);
      background:rgba(16,24,38,.55);
      margin:10px 0;
    }
    details.section[open]{ background:rgba(16,24,38,.70); }
    details.section > summary{
      list-style:none;
      cursor:pointer;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
      outline:none;
      border-bottom:var(--px) solid transparent;
    }
    details.section[open] > summary{
      border-bottom:var(--px) solid var(--line);
      background:linear-gradient(180deg, rgba(124,247,194,.08), rgba(0,0,0,0));
    }
    details.section > summary::-webkit-details-marker{ display:none; }
    .sumLeft{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
      font-size:12px;text-transform:uppercase;letter-spacing:.7px;color:var(--muted)
    }
    .sumLeft b{color:var(--text)}
    .sumRight{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end
    }
    .chev{
      width:22px;height:22px;display:grid;place-items:center;
      border:var(--px) solid var(--line);background:rgba(22,34,54,.85);
      color:var(--text);
      transform: rotate(0deg);
      transition: transform .18s ease;
      font-size:12px;
      flex:0 0 auto;
    }
    details.section[open] .chev{ transform: rotate(90deg); }
    .sectionBody{ padding:12px; }
    .sectionHint{ margin:-4px 0 10px; color:var(--muted); font-size:12px; line-height:1.35; }

    /* Nested details */
    details.nested{
      border:var(--px) solid rgba(38,50,70,.85);
      background:rgba(10,18,32,.55);
      margin:8px 0;
    }
    details.nested.cat-qi{ border-color:var(--cat-qi-br); background:rgba(10,18,32,.55); }
    details.nested.cat-system{ border-color:var(--cat-system-br); background:rgba(10,18,32,.55); }

    details.nested > summary{
      padding:10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      user-select:none;
      list-style:none;
    }
    details.nested > summary::-webkit-details-marker{ display:none; }
    details.nested[open] > summary{
      border-bottom:1px dashed rgba(38,50,70,.75);
      background:linear-gradient(180deg, rgba(255,209,102,.06), rgba(0,0,0,0));
    }
    details.nested .sectionBody{ padding:10px; }
    details.nested .chev{ width:20px;height:20px;font-size:11px; }
    .xpWarn{ color:var(--warn); }

    /* Loot */
    .lootGrid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:8px;
    }
    @media (max-width: 980px){ .lootGrid{grid-template-columns: repeat(3, 1fr)} }
    @media (max-width: 520px){ .lootGrid{grid-template-columns: repeat(2, 1fr)} }
    .lootCard{
      padding:10px;
      border:var(--px) solid var(--line);
      background:rgba(15,22,34,.8);
    }
    .lootCard .t{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.7px}
    .lootCard .v{font-size:16px;margin-top:6px}
    .lootMini{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.3}

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.65);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:18px;
    }
    .modal{
      width:min(560px, 100%);
      border:var(--px) solid var(--line);
      background:rgba(16,24,38,.95);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .modal .mh{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      border-bottom:var(--px) solid var(--line);
      padding-bottom:10px;margin-bottom:10px;
    }
    .modal .mh h3{margin:0;font-size:12px;letter-spacing:.9px;text-transform:uppercase}
    .modal .mb{font-size:12px;color:var(--muted);line-height:1.45}
    .modal .lootBig{
      margin:10px 0;
      padding:10px;
      border:var(--px) solid var(--line);
      background:rgba(10,18,32,.6);
      color:var(--text);
      font-size:13px;
    }
    .modal .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
    .modal .actions button{padding:8px 10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">üëë</div>
        <div>
          <h1>THE GAME OF FREEDOM ‚Äî SIFU MODE <span class="pill">v1.3</span></h1>
          <p>Journal du jour sticky en haut (desktop/tablette). Couleurs identiques par cat√©gorie.</p>
        </div>
      </div>
      <div class="controls">
        <div class="chip">
          <span>üìÖ Jour :</span>
          <input id="dateInput" type="date" />
        </div>
        <button id="btnToday">Aujourd‚Äôhui</button>
        <button id="btnReset">Reset du jour</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT (STICKY) -->
      <div class="panel leftSticky">
        <div class="hd">
          <h2>üìú Journal du jour</h2>
          <div class="status">Sauvegarde: <b class="ok">Auto</b> <span class="blink">‚ñ†</span></div>
        </div>

        <div class="bd">
          <div class="kpis">
            <div class="kpi">
              <div class="label">Libert√© % (Sifu = Libert√©+Responsabilit√©)</div>
              <div class="value" id="libPct">0%</div>
              <div class="bar"><span id="libBar"></span></div>
              <div class="status">Libert√© OK: <b id="libOk" class="no">FALSE</b></div>
            </div>

            <div class="kpi">
              <div class="label">XP gagn√©s (jour)</div>
              <div class="value" id="xpGained">0</div>
              <div class="status">
                üü¶ <b id="xpLib">0</b> ¬∑ üü© <b id="xpResp">0</b><br/>
                üü® <b id="xpDev">0</b> ¬∑ üü• <b id="xpEff">0</b>
              </div>
            </div>

            <div class="kpi">
              <div class="label">XP d√©pens√©s (jour)</div>
              <div class="value" id="xpSpent">0</div>
              <div class="status">Rewards: <span id="rewardGate">üîí Bloqu√©s</span></div>
            </div>

            <div class="kpi">
              <div class="label">Wallet (solde)</div>
              <div class="value" id="wallet">0</div>
              <div class="status">Solde = cumul jours (gagn√©s - d√©pens√©s).</div>
            </div>
          </div>

          <div class="divider"></div>

          <div id="sections"></div>

          <div class="footnote" id="ruleNote"></div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="hd">
          <h2>üéÅ Loot + Rewards + üìö Historique</h2>
          <div class="status">Seuil Libert√© OK = 40%</div>
        </div>

        <div class="bd">
          <!-- Loot Inventory -->
          <div class="lootGrid">
            <div class="lootCard">
              <div class="t">üßø Shields</div>
              <div class="v" id="invShields">0</div>
              <div class="lootMini">R√©serv√© (streak plus tard).</div>
            </div>
            <div class="lootCard">
              <div class="t">üí∏ Discounts</div>
              <div class="v" id="invDiscounts">0</div>
              <div class="lootMini">-50 XP auto sur le prochain reward.</div>
            </div>
            <div class="lootCard">
              <div class="t">üß† Boosts</div>
              <div class="v" id="invBoosts">0</div>
              <div class="lootMini">+20 XP instant (ajout√© au loot).</div>
            </div>
            <div class="lootCard">
              <div class="t">‚ö° Double XP</div>
              <div class="v" id="invDouble">0</div>
              <div class="lootMini">Actif demain sur une section.</div>
            </div>
            <div class="lootCard">
              <div class="t">üîÅ Rerolls</div>
              <div class="v" id="invRerolls">0</div>
              <div class="lootMini">Relance une loot (popup).</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="rewards" id="rewards"></div>

          <div class="divider"></div>

          <div class="sectionTitle" style="margin:0 0 8px;color:var(--muted);text-transform:uppercase;letter-spacing:.7px">
            üßæ Rewards du jour
          </div>
          <div class="log" id="dayLog"></div>

          <div class="divider"></div>

          <div class="sectionTitle" style="margin:0 0 8px;color:var(--muted);text-transform:uppercase;letter-spacing:.7px">
            üéÅ Loot du jour
          </div>
          <div class="log" id="lootLog"></div>

          <div class="divider"></div>

          <div class="sectionTitle" style="margin:0 0 8px;color:var(--muted);text-transform:uppercase;letter-spacing:.7px">
            üìö Historique
          </div>

          <div class="historyControls">
            <div class="left">
              <label class="badge">Vue</label>
              <select id="histMode">
                <option value="week">Semaine</option>
                <option value="month">Mois</option>
                <option value="all">Tout</option>
              </select>

              <label class="badge">Semaine</label>
              <input id="weekPick" type="date" />

              <label class="badge">Mois</label>
              <input id="monthPick" type="month" />
            </div>

            <div class="right">
              <button class="linkBtn" id="btnGoSelected">Aller au jour</button>
              <button class="linkBtn" id="btnExportJson">Export JSON</button>
              <button class="linkBtn" id="btnImportJson">Import JSON</button>
              <input id="importFile" type="file" accept="application/json" style="display:none"/>
            </div>
          </div>

          <div class="summaryGrid">
            <div class="sumCard">
              <div class="t">P√©riode</div>
              <div class="v" id="sumPeriod">‚Äî</div>
            </div>
            <div class="sumCard">
              <div class="t">XP net (gagn√©s - d√©pens√©s)</div>
              <div class="v" id="sumNet">0</div>
            </div>
            <div class="sumCard">
              <div class="t">Moyenne Libert√©%</div>
              <div class="v" id="sumLibAvg">0%</div>
            </div>
          </div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Libert√©% (Sifu)</th>
                  <th>XP gagn√©s</th>
                  <th>XP d√©pens√©s</th>
                  <th>Net</th>
                  <th>Libert√©</th>
                  <th>Responsabilit√©</th>
                  <th>D√©veloppement</th>
                  <th>Efficacit√©</th>
                  <th>Rewards</th>
                  <th>Loots</th>
                </tr>
              </thead>
              <tbody id="histBody"></tbody>
            </table>
          </div>

          <div class="footnote">
            Bonus section 100% = +30 XP (par section / par jour) + LOOT BOX (par section / par jour).
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loot Modal -->
  <div class="modalBack" id="lootModalBack">
    <div class="modal">
      <div class="mh">
        <h3 id="lootTitle">üéÅ Loot Box</h3>
        <button class="linkBtn" id="lootClose">Fermer</button>
      </div>
      <div class="mb" id="lootText">‚Äî</div>
      <div class="lootBig" id="lootBig">‚Äî</div>
      <div class="actions">
        <button id="lootReroll">Reroll (-1)</button>
        <button id="lootOk">OK</button>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  const STORAGE_KEY = "tgoF_sifu_v13_sticky_journal";
  const LIB_OK_THRESHOLD_PCT = 40;
  const SECTION_BONUS_XP = 30;

  // Cultivations (12) total 30xp
  const cultivationSteps = [
    { n:1, xp:1 }, { n:2, xp:1 }, { n:3, xp:1 }, { n:4, xp:3 },
    { n:5, xp:2 }, { n:6, xp:2 }, { n:7, xp:2 }, { n:8, xp:4 },
    { n:9, xp:3 }, { n:10, xp:3 }, { n:11, xp:3 }, { n:12, xp:5 },
  ];
  const cultivationTasks = cultivationSteps.map(s => ({
    id: `cult_${s.n}`,
    label: `üå± Cultivation ${s.n}`,
    xp: s.xp
  }));

  // Qi Pratique items (Cultivations is nested group)
  const qiPractice = [
    { id:"qi_cultivations_group", label:`üå± Cultivations (12)`, xp: 30, kind:"group" }, // display only
    { id:"qi_projections",  label:"üéØ Projections", xp:8  },
    { id:"qi_dantien",      label:"‚öôÔ∏è Dantien Tuna", xp:10 },
    { id:"qi_balancing",    label:"‚öñÔ∏è Balancing", xp:10 },
    { id:"qi_meditation",   label:"üßò Meditation", xp:15 },
    { id:"qi_expand",       label:"üå¨Ô∏è Expand & Condense", xp:30 },
    { id:"qi_dynamic",      label:"‚ö° Dynamic Qi", xp:10 },
  ];
  const QI_BONUS_XP = 15;

  // Libert√© standalone
  const libertyStandalone = [
    { id:"qi_cleansing",  label:"üåä Qi Cleansing", xp:70 },
    { id:"med1",          label:"üßò M√©ditation 1", xp:15 },
    { id:"med2",          label:"üßò M√©ditation 2", xp:15 },
    { id:"desengram",     label:"üß†‚ö° D√©sengrammage & D√©programmation", xp:50 },
    { id:"yoga",          label:"ü™∑ Yoga", xp:20 },
  ];

  // Syst√®me (4) + bonus
  const systemTasks = [
    { id:"sys_audio",     label:"üéß Audio", xp:25 },
    { id:"sys_lecture",   label:"üìñ Lecture", xp:25 },
    { id:"sys_relation",  label:"ü§ù Relation", xp:25 },
    { id:"sys_reco",      label:"‚≠ê Donner reconnaissance", xp:25 },
  ];
  const SYSTEM_BONUS_XP = 15;

  // Responsabilit√© (5)
  const responsibilityTasks = [
    { id:"bu_bw",         label:"üìò BU / BW", xp:40 },
    { id:"transgression", label:"üî• Transgression", xp:60 },
    { id:"wai",           label:"üëÅÔ∏è WAI", xp:20 },
    { id:"coeur",         label:"‚ù§Ô∏è C≈ìur (Coaching)", xp:20 },
    { id:"auto_cleans",   label:"üßº Auto-cleansing", xp:60 },
  ];

  // D√©veloppement (4)
  const developmentTasks = [
    { id:"vis_matin", label:"üåå Visualisation matin", xp:15 },
    { id:"vis_soir",  label:"üå† Visualisation soir", xp:15 },
    { id:"priere_m",  label:"üôè Pri√®re matin", xp:15 },
    { id:"priere_s",  label:"üïØÔ∏è Pri√®re soir", xp:15 },
  ];

  // Efficacit√© (2)
  const efficiencyTasks = [
    { id:"deep_work",     label:"üõ†Ô∏è Deep Work", xp:150 },
    { id:"communication", label:"üí¨ Communication", xp:120 },
  ];

  // Rewards (Sifu) ‚Äî Love
  const rewards = [
    { id:"r1_game",   name:"üéÆ Reward 1 ‚Äî Jeux / Jeux vid√©o", cost:440 },
    { id:"r2_film",   name:"üé¨ Reward 2 ‚Äî Film", cost:500 },
    { id:"r3_out",    name:"üö∂ Reward 3 ‚Äî Sortie dehors", cost:570 },
    { id:"r4_buy",    name:"üõçÔ∏è Reward 4 ‚Äî Objet ou service", cost:600 },
    { id:"r5_love_1", name:"üíñ Reward 5.1 ‚Äî Love", cost:620 },
    { id:"r5_love_2", name:"üíñ Reward 5.2 ‚Äî Love", cost:650 },
    { id:"r5_love_3", name:"üíñ Reward 5.3 ‚Äî Love", cost:680 },
    { id:"r6_rest_1", name:"üçΩÔ∏è Reward 6.1 ‚Äî Restaurant", cost:700 },
    { id:"r6_rest_2", name:"üçΩÔ∏è Reward 6.2 ‚Äî Restaurant", cost:750 },
  ];

  // Sections
  const SECTIONS = [
    { key:"lib",  title:"üü¶ Libert√©",       hint:"Qi Pratique + Libert√© + Syst√®me (compte dans Libert√©%).", meta:"Acte Libert√© (compte dans Libert√©%)." },
    { key:"resp", title:"üü© Responsabilit√©", hint:"Compte dans Libert√©% (mode Sifu).", meta:"Acte Responsabilit√© (compte dans Libert√©%).", tasks: responsibilityTasks },
    { key:"dev",  title:"üü® D√©veloppement",  hint:"XP seulement.", meta:"D√©veloppement (XP seulement).", tasks: developmentTasks },
    { key:"eff",  title:"üü• Efficacit√©",     hint:"XP seulement (Deep Work & Communication).", meta:"Efficacit√© (XP seulement).", tasks: efficiencyTasks },
  ];

  // Loot table (weighted)
  const LOOT_TABLE = [
    { type:"discount", label:"üí∏ Discount", desc:"-50 XP sur ton prochain reward (auto).",  weight: 28 },
    { type:"double",   label:"‚ö° Double XP", desc:"Demain, une section gagne double XP.",   weight: 22 },
    { type:"boost",    label:"üß† Boost",    desc:"+20 XP instant (ajout√© √† aujourd‚Äôhui).",  weight: 22 },
    { type:"shield",   label:"üßø Shield",   desc:"Jeton de protection (streak bient√¥t).",   weight: 18 },
    { type:"reroll",   label:"üîÅ Reroll",   desc:"+1 reroll pour relancer une loot.",       weight: 10 },
  ];

  // Helpers
  const el = (id) => document.getElementById(id);
  const todayISO = () => new Date().toISOString().slice(0,10);

  function pct(done, total){ return total ? Math.round((done / total) * 100) : 0; }
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function parseISO(s){ const [y,m,d] = s.split("-").map(Number); return new Date(y, m-1, d); }
  function toISODate(dt){
    const y = dt.getFullYear();
    const m = pad2(dt.getMonth()+1);
    const d = pad2(dt.getDate());
    return `${y}-${m}-${d}`;
  }
  function addDaysISO(dateISO, n){
    const dt = parseISO(dateISO);
    dt.setDate(dt.getDate() + n);
    return toISODate(dt);
  }
  function startOfWeekMonday(dt){
    const day = dt.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    const s = new Date(dt);
    s.setDate(dt.getDate() + diff);
    s.setHours(0,0,0,0);
    return s;
  }
  function endOfWeekSunday(dt){
    const s = startOfWeekMonday(dt);
    const e = new Date(s);
    e.setDate(s.getDate() + 6);
    e.setHours(0,0,0,0);
    return e;
  }
  function monthRangeFromYYYYMM(yyyymm){
    const [y,m] = yyyymm.split("-").map(Number);
    const start = new Date(y, m-1, 1);
    const end = new Date(y, m, 0);
    start.setHours(0,0,0,0);
    end.setHours(0,0,0,0);
    return { start, end };
  }
  function daysBetweenInclusive(start, end){
    const out = [];
    const cur = new Date(start);
    cur.setHours(0,0,0,0);
    const e = new Date(end);
    e.setHours(0,0,0,0);
    while(cur <= e){
      out.push(toISODate(cur));
      cur.setDate(cur.getDate()+1);
    }
    return out;
  }
  function weightedPick(items){
    let sum = 0;
    for(const it of items) sum += it.weight;
    let r = Math.random() * sum;
    for(const it of items){
      r -= it.weight;
      if(r <= 0) return it;
    }
    return items[items.length-1];
  }

  // Flatten tasks
  const qiFlatTasks = [
    ...cultivationTasks,
    ...qiPractice.filter(t => t.id !== "qi_cultivations_group")
  ];
  const libertyFlatTasks = [
    ...qiFlatTasks,
    ...libertyStandalone,
    ...systemTasks
  ];
  const allTasksFlat = [
    ...libertyFlatTasks,
    ...responsibilityTasks,
    ...developmentTasks,
    ...efficiencyTasks
  ];
  const libertyPctTasksFlat = [
    ...libertyFlatTasks,
    ...responsibilityTasks
  ];

  function sectionTaskIds(key){
    if(key === "lib"){
      return [
        ...cultivationTasks.map(t=>t.id),
        ...qiPractice.filter(t=>t.id!=="qi_cultivations_group").map(t=>t.id),
        ...libertyStandalone.map(t=>t.id),
        ...systemTasks.map(t=>t.id),
      ];
    }
    if(key === "resp") return responsibilityTasks.map(t=>t.id);
    if(key === "dev")  return developmentTasks.map(t=>t.id);
    if(key === "eff")  return efficiencyTasks.map(t=>t.id);
    return [];
  }

  // State
  const state = loadState();

  // UI init
  el("dateInput").value = state.currentDate || todayISO();
  state.currentDate = el("dateInput").value;

  el("histMode").value = "week";
  el("weekPick").value = state.currentDate;
  el("monthPick").value = state.currentDate.slice(0,7);

  renderSections();
  renderRewards();
  syncUI();
  renderHistory();

  // Events
  el("dateInput").addEventListener("change", () => {
    state.currentDate = el("dateInput").value;
    ensureDay(state.currentDate);
    el("weekPick").value = state.currentDate;
    el("monthPick").value = state.currentDate.slice(0,7);
    saveState();
    syncUI();
    renderHistory();
  });

  el("btnToday").addEventListener("click", () => {
    state.currentDate = todayISO();
    el("dateInput").value = state.currentDate;
    ensureDay(state.currentDate);
    el("weekPick").value = state.currentDate;
    el("monthPick").value = state.currentDate.slice(0,7);
    saveState();
    syncUI();
    renderHistory();
  });

  el("btnReset").addEventListener("click", () => {
    const d = state.currentDate;
    if(!confirm("Reset toutes les cases, loots, et achats de CE JOUR ?")) return;
    state.days[d] = createEmptyDay();
    saveState();
    renderRewards();
    syncUI(false);
    renderHistory();
  });

  el("histMode").addEventListener("change", renderHistory);
  el("weekPick").addEventListener("change", renderHistory);
  el("monthPick").addEventListener("change", renderHistory);

  el("btnGoSelected").addEventListener("click", () => {
    const pick = el("weekPick").value || state.currentDate;
    state.currentDate = pick;
    el("dateInput").value = pick;
    ensureDay(pick);
    el("weekPick").value = pick;
    el("monthPick").value = pick.slice(0,7);
    saveState();
    syncUI();
    renderHistory();
  });

  el("btnExportJson").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "the-game-of-freedom-save.json";
    a.click();
    URL.revokeObjectURL(url);
  });

  el("btnImportJson").addEventListener("click", () => el("importFile").click());
  el("importFile").addEventListener("change", async (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    try{
      const text = await file.text();
      const obj = JSON.parse(text);
      if(!obj || typeof obj !== "object" || typeof obj.days !== "object"){
        alert("Fichier invalide.");
        return;
      }
      state.currentDate = obj.currentDate || state.currentDate || todayISO();
      state.days = obj.days || {};
      state.walletBase = obj.walletBase || 0;
      state.ui = obj.ui || state.ui || { open:{ lib:true, resp:false, dev:false, eff:false }, nested:{} };

      state.inventory = obj.inventory || state.inventory || createInventory();
      state.lootHistory = obj.lootHistory || state.lootHistory || [];

      ensureDay(state.currentDate);

      migrateEnsureAllTasks(state);
      migrateEnsureLootKeys(state);
      cleanupExpiredDoubleXP(state);

      el("dateInput").value = state.currentDate;
      el("weekPick").value = state.currentDate;
      el("monthPick").value = state.currentDate.slice(0,7);

      saveState();
      renderSections();
      renderRewards();
      syncUI();
      renderHistory();
      alert("Import OK ‚úÖ");
    }catch(err){
      console.error(err);
      alert("Impossible d'importer (JSON invalide).");
    }finally{
      e.target.value = "";
    }
  });

  // Modal events
  el("lootClose").addEventListener("click", closeLootModal);
  el("lootOk").addEventListener("click", closeLootModal);

  // Storage
  function createInventory(){
    return {
      shields: 0,
      discounts: 0,
      boosts: 0,
      rerolls: 0,
      doubleXP: [] // [{date:'YYYY-MM-DD', section:'lib'|'resp'|'dev'|'eff'}]
    };
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      const parsed = raw ? JSON.parse(raw) : null;

      const base = (parsed && typeof parsed === "object") ? parsed : {
        currentDate: todayISO(),
        days:{},
        walletBase:0,
        ui:{ open:{ lib:true, resp:false, dev:false, eff:false }, nested:{ qi:true, system:false, cultivation:false } },
        inventory: createInventory(),
        lootHistory: []
      };

      base.days = base.days || {};
      base.walletBase = base.walletBase || 0;
      base.currentDate = base.currentDate || todayISO();
      base.ui = base.ui || { open:{}, nested:{} };
      base.ui.open = base.ui.open || { lib:true, resp:false, dev:false, eff:false };
      base.ui.nested = base.ui.nested || { qi:true, system:false, cultivation:false };

      base.inventory = base.inventory || createInventory();
      base.lootHistory = base.lootHistory || [];

      ensureDay(base.currentDate, base);
      migrateEnsureAllTasks(base);
      migrateEnsureLootKeys(base);
      cleanupExpiredDoubleXP(base);

      return base;
    }catch(_){
      const fallback = {
        currentDate: todayISO(),
        days:{},
        walletBase:0,
        ui:{ open:{ lib:true, resp:false, dev:false, eff:false }, nested:{ qi:true, system:false, cultivation:false } },
        inventory: createInventory(),
        lootHistory: []
      };
      ensureDay(fallback.currentDate, fallback);
      migrateEnsureAllTasks(fallback);
      migrateEnsureLootKeys(fallback);
      return fallback;
    }
  }

  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function ensureDay(date, st=state){
    if(!st.days[date]) st.days[date] = createEmptyDay();
  }

  function createEmptyDay(){
    const checked = {};
    allTasksFlat.forEach(t => checked[t.id] = false);
    return {
      checked,
      purchases: [],
      sectionLooted: { lib:false, resp:false, dev:false, eff:false },
      lootBoostXP: 0,
      loots: []
    };
  }

  function migrateEnsureAllTasks(st){
    for(const date of Object.keys(st.days||{})){
      const day = st.days[date];
      day.checked = day.checked || {};
      for(const t of allTasksFlat){
        if(typeof day.checked[t.id] !== "boolean") day.checked[t.id] = false;
      }
      day.purchases = day.purchases || [];
    }
  }

  function migrateEnsureLootKeys(st){
    st.inventory = st.inventory || createInventory();
    st.inventory.shields   = Number(st.inventory.shields||0);
    st.inventory.discounts = Number(st.inventory.discounts||0);
    st.inventory.boosts    = Number(st.inventory.boosts||0);
    st.inventory.rerolls   = Number(st.inventory.rerolls||0);
    st.inventory.doubleXP  = Array.isArray(st.inventory.doubleXP) ? st.inventory.doubleXP : [];

    st.lootHistory = Array.isArray(st.lootHistory) ? st.lootHistory : [];

    for(const date of Object.keys(st.days||{})){
      const day = st.days[date];
      day.sectionLooted = day.sectionLooted || { lib:false, resp:false, dev:false, eff:false };
      for(const k of ["lib","resp","dev","eff"]){
        if(typeof day.sectionLooted[k] !== "boolean") day.sectionLooted[k] = false;
      }
      if(typeof day.lootBoostXP !== "number") day.lootBoostXP = Number(day.lootBoostXP||0);
      day.loots = Array.isArray(day.loots) ? day.loots : [];
    }
  }

  function cleanupExpiredDoubleXP(st){
    const today = todayISO();
    st.inventory.doubleXP = st.inventory.doubleXP.filter(x => x && x.date >= today && x.section);
  }

  // Category ‚Üí CSS class
  function catClass(cat){
    const map = {
      qi: "cat-qi",
      system: "cat-system",
      lib: "cat-lib",
      resp: "cat-resp",
      dev: "cat-dev",
      eff: "cat-eff",
    };
    return map[cat] || "";
  }

  // Render helpers
  function taskRow(task, meta, cat){
    const row = document.createElement("div");
    row.className = `task ${catClass(cat)}`;
    row.innerHTML = `
      <div class="left">
        <input type="checkbox" id="ck_${task.id}">
        <div>
          <label for="ck_${task.id}"><b>${task.label}</b></label>
          <div class="meta">${meta}</div>
        </div>
      </div>
      <div class="xp"><span>+${task.xp}</span><small>XP</small></div>
    `;
    row.querySelector(`#ck_${task.id}`).addEventListener("change",(e)=>{
      const d = state.currentDate;
      state.days[d].checked[task.id] = e.target.checked;
      saveState();
      syncUI();
      renderHistory();
    });
    return row;
  }

  function nestedDetails(key, titleHtml, rightHtml, bodyBuilder, cat){
    const details = document.createElement("details");
    details.className = `nested ${catClass(cat)}`;
    const open = !!state.ui?.nested?.[key];
    details.open = open;

    details.addEventListener("toggle", ()=>{
      state.ui = state.ui || { open:{}, nested:{} };
      state.ui.nested = state.ui.nested || {};
      state.ui.nested[key] = details.open;
      saveState();
    });

    details.innerHTML = `
      <summary>
        <div class="sumLeft" style="font-size:12px; text-transform:none; letter-spacing:.2px">
          <span class="chev">‚ñ∂</span>
          <b>${titleHtml}</b>
        </div>
        <div class="sumRight">
          ${rightHtml || ""}
        </div>
      </summary>
      <div class="sectionBody" id="nested_body_${key}"></div>
    `;

    const body = details.querySelector(`#nested_body_${key}`);
    bodyBuilder(body, details);
    return details;
  }

  // Render sections
  function renderSections(){
    const wrap = el("sections");
    wrap.innerHTML = "";

    for(const s of SECTIONS){
      const details = document.createElement("details");
      details.className = "section";
      details.open = !!state.ui?.open?.[s.key];

      details.addEventListener("toggle", ()=>{
        state.ui = state.ui || { open:{}, nested:{} };
        state.ui.open = state.ui.open || {};
        state.ui.open[s.key] = details.open;
        saveState();
      });

      details.innerHTML = `
        <summary>
          <div class="sumLeft">
            <span class="chev">‚ñ∂</span>
            <b>${s.title}</b>
          </div>
          <div class="sumRight">
            <span class="badge" id="pct_${s.key}">0%</span>
            <span class="badge" id="done_${s.key}">0/0</span>
            <span class="badge" id="bonus_${s.key}">Bonus: 0</span>
            <span class="badge" id="loot_${s.key}">Loot: 0</span>
          </div>
        </summary>
        <div class="sectionBody">
          <div class="sectionHint">${s.hint}</div>
          <div id="body_${s.key}"></div>
        </div>
      `;

      wrap.appendChild(details);
      const body = details.querySelector(`#body_${s.key}`);

      if(s.key === "lib"){
        body.appendChild(renderQiPratiqueNested());
        libertyStandalone.forEach(t => body.appendChild(taskRow(t, s.meta, "lib")));
        body.appendChild(renderSystemNested());
      } else if(s.key === "resp"){
        (s.tasks || []).forEach(t => body.appendChild(taskRow(t, s.meta, "resp")));
      } else if(s.key === "dev"){
        (s.tasks || []).forEach(t => body.appendChild(taskRow(t, s.meta, "dev")));
      } else if(s.key === "eff"){
        (s.tasks || []).forEach(t => body.appendChild(taskRow(t, s.meta, "eff")));
      } else {
        (s.tasks || []).forEach(t => body.appendChild(taskRow(t, s.meta)));
      }
    }
  }

  function renderQiPratiqueNested(){
    return nestedDetails(
      "qi",
      "üúÇ Qi Pratique",
      `<span class="badge" id="qiDone">0/0</span><span class="badge" id="qiPct">0%</span><span class="badge xpWarn" id="qiXp">0 XP</span>`,
      (body) => {
        body.appendChild(renderCultivationsNested());
        qiPractice
          .filter(t => t.id !== "qi_cultivations_group")
          .forEach(t => body.appendChild(taskRow(t, "Qi Pratique (compte dans Libert√©%).", "qi")));

        const note = document.createElement("div");
        note.className = "sectionHint";
        note.style.marginTop = "8px";
        note.textContent = "Bonus Qi Pratique: +15 XP si TOUT Qi Pratique est compl√©t√© (incluant toutes les Cultivations).";
        body.appendChild(note);
      },
      "qi"
    );
  }

  function renderCultivationsNested(){
    return nestedDetails(
      "cultivation",
      "üå± Cultivations (12 √©tapes) ‚Äî Total 30 XP",
      `<span class="badge" id="cultDone">0/12</span><span class="badge" id="cultPct">0%</span><span class="badge xpWarn" id="cultXp">0 XP</span>`,
      (body) => {
        cultivationTasks.forEach(t=>{
          body.appendChild(taskRow(t, "Sous-√©tape de Cultivations (compte dans Libert√©%).", "qi"));
        });
      },
      "qi"
    );
  }

  function renderSystemNested(){
    return nestedDetails(
      "system",
      "üß± Syst√®me / Organisation (4)",
      `<span class="badge" id="sysDone">0/4</span><span class="badge" id="sysPct">0%</span><span class="badge xpWarn" id="sysXp">0 XP</span>`,
      (body) => {
        systemTasks.forEach(t=>{
          body.appendChild(taskRow(t, "Syst√®me (compte dans Libert√©%).", "system"));
        });
        const note = document.createElement("div");
        note.className = "sectionHint";
        note.style.marginTop = "8px";
        note.textContent = "Bonus Syst√®me: +15 XP si les 4 √©l√©ments sont compl√©t√©s.";
        body.appendChild(note);
      },
      "system"
    );
  }

  // Rewards
  function renderRewards(){
    const wrap = el("rewards");
    wrap.innerHTML = "";
    rewards.forEach(r=>{
      const row = document.createElement("div");
      row.className = "reward";

      const hasDiscount = state.inventory.discounts > 0;
      const finalCost = Math.max(0, r.cost - (hasDiscount ? 50 : 0));

      row.innerHTML = `
        <div>
          <div class="name"><b>${r.name}</b></div>
          <div class="hint">
            Co√ªt: <span class="cost">${r.cost} XP</span>
            ${hasDiscount ? `<span class="pill">Discount dispo: -50 ‚Üí <b>${finalCost} XP</b></span>` : ``}
          </div>
        </div>
        <div class="right">
          <div class="cost">${hasDiscount ? finalCost : r.cost} XP</div>
          <button id="buy_${r.id}">Prendre</button>
        </div>
      `;
      wrap.appendChild(row);
      row.querySelector(`#buy_${r.id}`).addEventListener("click", ()=> attemptBuy(r));
    });
  }

  // XP calc
  function calcSectionBonus(done, total){
    return (total > 0 && done === total) ? SECTION_BONUS_XP : 0;
  }
  function countDoneByIds(checked, ids){
    let done = 0;
    for(const id of ids) if(checked[id]) done += 1;
    return { done, total: ids.length, pct: pct(done, ids.length) };
  }
  function calcCultivationXP(checked){
    let xp = 0, done = 0;
    for(const t of cultivationTasks){
      if(checked[t.id]){ xp += t.xp; done += 1; }
    }
    const total = cultivationTasks.length;
    return { xp, done, total, pct: pct(done,total), all: done === total };
  }
  function calcQiXP(checked){
    const cult = calcCultivationXP(checked);
    let xp = cult.xp, done = cult.done, total = cult.total;

    for(const t of qiPractice){
      if(t.id === "qi_cultivations_group") continue;
      total += 1;
      if(checked[t.id]){ xp += t.xp; done += 1; }
    }
    const all = (done === total);
    if(all) xp += QI_BONUS_XP;
    return { xp, done, total, pct: pct(done,total), all, cult };
  }
  function calcSystemXP(checked){
    let xp = 0, done = 0;
    for(const t of systemTasks){
      if(checked[t.id]){ xp += t.xp; done += 1; }
    }
    const total = systemTasks.length;
    const all = done === total;
    if(all) xp += SYSTEM_BONUS_XP;
    return { xp, done, total, pct: pct(done,total), all };
  }
  function getDoubleXPForDateSection(date, sectionKey){
    return state.inventory.doubleXP.some(x => x && x.date === date && x.section === sectionKey);
  }

  function calcDayXP(date){
    const day = state.days[date];
    if(!day) return { gained:0, spent:0, breakdown:{}, sectionBonus:{}, counts:{}, qi:{}, sys:{}, cult:{}, lootsCount:0 };

    const checked = day.checked || {};

    const qi = calcQiXP(checked);
    let libStandaloneXP = 0;
    for(const t of libertyStandalone){ if(checked[t.id]) libStandaloneXP += t.xp; }
    const sys = calcSystemXP(checked);

    let libXP_raw = qi.xp + libStandaloneXP + sys.xp;

    let respXP_raw = 0;
    for(const t of responsibilityTasks){ if(checked[t.id]) respXP_raw += t.xp; }

    let devXP_raw = 0;
    for(const t of developmentTasks){ if(checked[t.id]) devXP_raw += t.xp; }

    let effXP_raw = 0;
    for(const t of efficiencyTasks){ if(checked[t.id]) effXP_raw += t.xp; }

    // Double XP applies to raw (not to +30 completion bonus)
    if(getDoubleXPForDateSection(date, "lib"))  libXP_raw *= 2;
    if(getDoubleXPForDateSection(date, "resp")) respXP_raw *= 2;
    if(getDoubleXPForDateSection(date, "dev"))  devXP_raw *= 2;
    if(getDoubleXPForDateSection(date, "eff"))  effXP_raw *= 2;

    const cLib  = countDoneByIds(checked, sectionTaskIds("lib"));
    const cResp = countDoneByIds(checked, sectionTaskIds("resp"));
    const cDev  = countDoneByIds(checked, sectionTaskIds("dev"));
    const cEff  = countDoneByIds(checked, sectionTaskIds("eff"));

    const bonusLib  = calcSectionBonus(cLib.done,  cLib.total);
    const bonusResp = calcSectionBonus(cResp.done, cResp.total);
    const bonusDev  = calcSectionBonus(cDev.done,  cDev.total);
    const bonusEff  = calcSectionBonus(cEff.done,  cEff.total);

    const lootBoostXP = Number(day.lootBoostXP||0);

    const libXP  = libXP_raw  + bonusLib;
    const respXP = respXP_raw + bonusResp;
    const devXP  = devXP_raw  + bonusDev;
    const effXP  = effXP_raw  + bonusEff;

    const gained = libXP + respXP + devXP + effXP + lootBoostXP;
    const spent = (day.purchases||[]).reduce((a,p)=>a + (p.cost||0), 0);

    return {
      gained, spent,
      breakdown:{ lib:libXP, resp:respXP, dev:devXP, eff:effXP, boost:lootBoostXP },
      sectionBonus:{ lib:bonusLib, resp:bonusResp, dev:bonusDev, eff:bonusEff },
      counts:{ lib:cLib, resp:cResp, dev:cDev, eff:cEff },
      qi, sys, cult: qi.cult,
      lootsCount: (day.loots||[]).length
    };
  }

  function calcLibertyPct(date){
    const day = state.days[date];
    const checked = (day && day.checked) ? day.checked : {};
    const total = libertyPctTasksFlat.length;
    let done = 0;
    for(const t of libertyPctTasksFlat){
      if(checked[t.id]) done += 1;
    }
    const p = total ? Math.round((done / total) * 100) : 0;
    return { pct: p, done, total, libOk: p >= LIB_OK_THRESHOLD_PCT };
  }

  function calcWallet(){
    const dates = Object.keys(state.days||{});
    let total = state.walletBase || 0;
    for(const d of dates){
      const x = calcDayXP(d);
      total += (x.gained - x.spent);
    }
    return total;
  }

  // Loot system
  function sectionName(key){
    const m = { lib:"Libert√©", resp:"Responsabilit√©", dev:"D√©veloppement", eff:"Efficacit√©" };
    return m[key] || key;
  }

  function grantLootForSection(date, sectionKey){
    const day = state.days[date];
    const loot = weightedPick(LOOT_TABLE);

    applyLoot(date, sectionKey, loot);

    const msg = `üéÅ [${date}] ${sectionName(sectionKey)} ‚Üí ${loot.label} (${loot.desc})`;
    state.lootHistory.unshift(msg);
    if(state.lootHistory.length > 250) state.lootHistory.length = 250;

    day.sectionLooted[sectionKey] = true;
    day.loots.push({ section: sectionKey, type: loot.type, label: loot.label, desc: loot.desc, ts: new Date().toISOString() });

    saveState();
    openLootModal({ date, sectionKey, loot });
    renderRewards();
    syncUI(false);
    renderHistory();
  }

  function applyLoot(date, sectionKey, loot){
    const day = state.days[date];

    if(loot.type === "discount") state.inventory.discounts += 1;
    if(loot.type === "shield") state.inventory.shields += 1;
    if(loot.type === "reroll") state.inventory.rerolls += 1;

    if(loot.type === "boost"){
      state.inventory.boosts += 1;
      day.lootBoostXP = Number(day.lootBoostXP||0) + 20;
    }

    if(loot.type === "double"){
      const tomorrow = addDaysISO(date, 1);
      const sections = ["lib","resp","dev","eff"];
      const chosen = sections[Math.floor(Math.random()*sections.length)];
      state.inventory.doubleXP.push({ date: tomorrow, section: chosen });
      cleanupExpiredDoubleXP(state);
    }
  }

  function checkLootTriggers(date, xpDay){
    const day = state.days[date];
    for(const key of ["lib","resp","dev","eff"]){
      const c = xpDay.counts[key];
      const already = !!day.sectionLooted[key];
      const completed = (c.total > 0 && c.done === c.total);
      if(completed && !already){
        grantLootForSection(date, key);
        return; // one popup at a time
      }
    }
  }

  // Modal
  function openLootModal(ctx){
    el("lootModalBack").style.display = "flex";
    el("lootTitle").textContent = `üéÅ Loot Box ‚Äî ${sectionName(ctx.sectionKey)} (${ctx.date})`;
    el("lootText").textContent = `Section 100% ‚Üí +30 XP + Loot Box.`;
    el("lootBig").innerHTML = `<b>${ctx.loot.label}</b> ‚Äî ${escapeHtml(ctx.loot.desc)}`;

    const rerollBtn = el("lootReroll");
    rerollBtn.disabled = !(state.inventory.rerolls > 0);
    rerollBtn.onclick = () => {
      if(state.inventory.rerolls <= 0) return;
      state.inventory.rerolls -= 1;

      const newLoot = weightedPick(LOOT_TABLE);
      applyLoot(ctx.date, ctx.sectionKey, newLoot);

      const msg = `üé≤ [${ctx.date}] REROLL ${sectionName(ctx.sectionKey)} ‚Üí ${newLoot.label} (${newLoot.desc})`;
      state.lootHistory.unshift(msg);
      if(state.lootHistory.length > 250) state.lootHistory.length = 250;

      state.days[ctx.date].loots.push({ section: ctx.sectionKey, type: newLoot.type, label: newLoot.label, desc: newLoot.desc, ts: new Date().toISOString(), reroll:true });

      saveState();

      el("lootBig").innerHTML = `<b>${newLoot.label}</b> ‚Äî ${escapeHtml(newLoot.desc)} <span class="pill">REROLL</span>`;
      rerollBtn.disabled = !(state.inventory.rerolls > 0);

      renderRewards();
      syncUI(false);
      renderHistory();
    };
  }
  function closeLootModal(){ el("lootModalBack").style.display = "none"; }

  // Economy
  function attemptBuy(reward){
    const d = state.currentDate;
    ensureDay(d);

    const { libOk } = calcLibertyPct(d);
    if(!libOk){
      alert("üîí Rewards BLOQU√âS : Libert√© OK est FALSE.");
      return;
    }

    let finalCost = reward.cost;
    let discountUsed = 0;
    if(state.inventory.discounts > 0){
      discountUsed = 50;
      finalCost = Math.max(0, reward.cost - 50);
    }

    const wallet = calcWallet();
    if(wallet < finalCost){
      alert(`Pas assez de XP.\nWallet: ${wallet} XP\nCo√ªt: ${finalCost} XP`);
      return;
    }

    if(discountUsed) state.inventory.discounts -= 1;

    state.days[d].purchases.push({
      id: reward.id,
      name: reward.name,
      cost: finalCost,
      baseCost: reward.cost,
      discountUsed,
      ts: new Date().toISOString()
    });

    saveState();
    renderRewards();
    syncUI(false);
    renderHistory();
  }

  // Sync UI
  function syncUI(allowLootCheck=true){
    const d = state.currentDate;
    ensureDay(d);
    const checked = state.days[d].checked;

    for(const t of allTasksFlat){
      const input = document.getElementById(`ck_${t.id}`);
      if(input) input.checked = !!checked[t.id];
    }

    const lib = calcLibertyPct(d);
    el("libPct").textContent = `${lib.pct}% (${lib.done}/${lib.total})`;
    el("libBar").style.width = `${Math.min(100, Math.max(0, lib.pct))}%`;
    const okEl = el("libOk");
    okEl.textContent = lib.libOk ? "TRUE" : "FALSE";
    okEl.className = lib.libOk ? "ok" : "no";

    const xp = calcDayXP(d);
    el("xpGained").textContent = xp.gained;
    el("xpSpent").textContent = xp.spent;
    el("wallet").textContent = calcWallet();

    el("xpLib").textContent = xp.breakdown.lib;
    el("xpResp").textContent = xp.breakdown.resp;
    el("xpDev").textContent = xp.breakdown.dev;
    el("xpEff").textContent = xp.breakdown.eff;

    setSectionHeader("lib",  xp.counts.lib,  xp.sectionBonus.lib,  state.days[d].sectionLooted.lib);
    setSectionHeader("resp", xp.counts.resp, xp.sectionBonus.resp, state.days[d].sectionLooted.resp);
    setSectionHeader("dev",  xp.counts.dev,  xp.sectionBonus.dev,  state.days[d].sectionLooted.dev);
    setSectionHeader("eff",  xp.counts.eff,  xp.sectionBonus.eff,  state.days[d].sectionLooted.eff);

    function setSectionHeader(key, c, bonus, looted){
      const a = document.getElementById(`pct_${key}`);
      const b = document.getElementById(`done_${key}`);
      const cEl = document.getElementById(`bonus_${key}`);
      const lEl = document.getElementById(`loot_${key}`);
      if(a) a.textContent = `${c.pct}%`;
      if(b) b.textContent = `${c.done}/${c.total}`;
      if(cEl) cEl.textContent = `Bonus: ${bonus}`;
      if(lEl) lEl.textContent = `Loot: ${looted ? "‚úÖ" : "‚Äî"}`;
    }

    if(el("qiDone")) el("qiDone").textContent = `${xp.qi.done}/${xp.qi.total}`;
    if(el("qiPct"))  el("qiPct").textContent  = `${xp.qi.pct}%`;
    if(el("qiXp"))   el("qiXp").textContent   = `${xp.qi.xp} XP${getDoubleXPForDateSection(d,"lib") ? " ‚ö°" : ""}`;

    if(el("cultDone")) el("cultDone").textContent = `${xp.cult.done}/${xp.cult.total}`;
    if(el("cultPct"))  el("cultPct").textContent  = `${xp.cult.pct}%`;
    if(el("cultXp"))   el("cultXp").textContent   = `${xp.cult.xp} XP`;

    if(el("sysDone")) el("sysDone").textContent = `${xp.sys.done}/${xp.sys.total}`;
    if(el("sysPct"))  el("sysPct").textContent  = `${xp.sys.pct}%`;
    if(el("sysXp"))   el("sysXp").textContent   = `${xp.sys.xp} XP`;

    el("ruleNote").textContent =
      `Seuil Libert√© OK = ${LIB_OK_THRESHOLD_PCT}%. Bonus section 100% = +${SECTION_BONUS_XP} XP + 1 Loot Box (par section/jour). ` +
      `${state.days[d].lootBoostXP ? `Boost loot aujourd‚Äôhui: +${state.days[d].lootBoostXP} XP.` : ""}`;

    el("rewardGate").textContent = lib.libOk ? "‚úÖ Autoris√©s" : "üîí Bloqu√©s";
    rewards.forEach(r=>{
      const btn = document.getElementById(`buy_${r.id}`);
      if(btn) btn.disabled = !lib.libOk;
    });

    // Rewards log
    const purchases = state.days[d].purchases || [];
    el("dayLog").innerHTML = purchases.length
      ? purchases.slice().reverse().map(p=>{
          const disc = p.discountUsed ? ` <span class="pill">-50</span>` : ``;
          return `<div class="item">‚úÖ ${escapeHtml(p.name)} <span class="pill">-${p.cost} XP</span>${disc}</div>`;
        }).join("")
      : `<div class="item">Aucun reward pris aujourd‚Äôhui.</div>`;

    // Loot log
    const dayLoots = state.days[d].loots || [];
    el("lootLog").innerHTML = dayLoots.length
      ? dayLoots.slice().reverse().map(l =>
          `<div class="item">üéÅ ${escapeHtml(sectionName(l.section))} ‚Üí <b>${escapeHtml(l.label)}</b> <span class="pill">${escapeHtml(l.type)}</span></div>`
        ).join("")
      : `<div class="item">Aucun loot aujourd‚Äôhui.</div>`;

    // Inventory UI
    el("invShields").textContent = String(state.inventory.shields);
    el("invDiscounts").textContent = String(state.inventory.discounts);
    el("invBoosts").textContent = String(state.inventory.boosts);
    el("invRerolls").textContent = String(state.inventory.rerolls);
    el("invDouble").textContent = String(state.inventory.doubleXP.length);

    // Loot triggers
    if(allowLootCheck && el("lootModalBack").style.display !== "flex"){
      checkLootTriggers(d, xp);
    }
  }

  // History
  function getRangeForHistory(){
    const mode = el("histMode").value;

    if(mode === "all"){
      const dates = Object.keys(state.days||{}).sort();
      if(dates.length === 0){
        const t = todayISO();
        return { dates:[t], label:"Tout (vide)" };
      }
      return { dates, label:`Tout (${dates[0]} ‚Üí ${dates[dates.length-1]})` };
    }

    if(mode === "month"){
      const m = el("monthPick").value || state.currentDate.slice(0,7);
      const {start, end} = monthRangeFromYYYYMM(m);
      return { dates: daysBetweenInclusive(start, end), label:`Mois ${m}` };
    }

    const pick = el("weekPick").value || state.currentDate;
    const dt = parseISO(pick);
    const start = startOfWeekMonday(dt);
    const end = endOfWeekSunday(dt);
    return { dates: daysBetweenInclusive(start, end), label:`Semaine ${toISODate(start)} ‚Üí ${toISODate(end)}` };
  }

  function dayRowModel(date){
    const day = state.days[date];
    if(!day){
      return {
        date, has:false, libertyPct:0, xpGained:0, xpSpent:0, net:0,
        cLib:{pct:0, done:0, total:0},
        cResp:{pct:0, done:0, total:0},
        cDev:{pct:0, done:0, total:0},
        cEff:{pct:0, done:0, total:0},
        rewardsCount:0, lootsCount:0
      };
    }

    const libertyPct = calcLibertyPct(date).pct;
    const xp = calcDayXP(date);

    return {
      date, has:true, libertyPct,
      xpGained: xp.gained,
      xpSpent: xp.spent,
      net: xp.gained - xp.spent,
      cLib: xp.counts.lib,
      cResp: xp.counts.resp,
      cDev: xp.counts.dev,
      cEff: xp.counts.eff,
      rewardsCount: (day.purchases||[]).length,
      lootsCount: (day.loots||[]).length
    };
  }

  function renderHistory(){
    const r = getRangeForHistory();
    const rows = r.dates.map(dayRowModel);

    const used = rows.filter(x => x.has);
    const net = used.reduce((a,x)=>a+x.net,0);
    const libAvg = used.length ? Math.round(used.reduce((a,x)=>a+x.libertyPct,0) / used.length) : 0;

    el("sumPeriod").textContent = r.label;
    el("sumNet").textContent = String(net);
    el("sumLibAvg").textContent = `${libAvg}%`;

    const body = el("histBody");
    body.innerHTML = rows
      .slice()
      .reverse()
      .map(x => {
        const dim = x.has ? "" : ` style="opacity:.55"`;
        const dateBtn = `<button class="linkBtn" data-go="${x.date}">${x.date}</button>`;
        return `
          <tr${dim}>
            <td>${dateBtn}</td>
            <td>${x.libertyPct}%</td>
            <td>${x.xpGained}</td>
            <td>${x.xpSpent}</td>
            <td>${x.net}</td>
            <td>${x.cLib.pct}% (${x.cLib.done}/${x.cLib.total})</td>
            <td>${x.cResp.pct}% (${x.cResp.done}/${x.cResp.total})</td>
            <td>${x.cDev.pct}% (${x.cDev.done}/${x.cDev.total})</td>
            <td>${x.cEff.pct}% (${x.cEff.done}/${x.cEff.total})</td>
            <td>${x.rewardsCount}</td>
            <td>${x.lootsCount}</td>
          </tr>
        `;
      })
      .join("");

    body.querySelectorAll("[data-go]").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        const d = e.currentTarget.getAttribute("data-go");
        state.currentDate = d;
        el("dateInput").value = d;
        ensureDay(d);
        el("weekPick").value = d;
        el("monthPick").value = d.slice(0,7);
        saveState();
        syncUI();
        renderHistory();
      });
    });
  }

  // ===== Missing functions from prior version (renderSections / nested / etc.) =====
  // (Copied as-is from v1.2 with no functional change except STORAGE_KEY and sticky CSS)

  function sectionName(key){
    const m = { lib:"Libert√©", resp:"Responsabilit√©", dev:"D√©veloppement", eff:"Efficacit√©" };
    return m[key] || key;
  }

  function renderSections(){
    const wrap = el("sections");
    wrap.innerHTML = "";

    for(const s of SECTIONS){
      const details = document.createElement("details");
      details.className = "section";
      details.open = !!state.ui?.open?.[s.key];

      details.addEventListener("toggle", ()=>{
        state.ui = state.ui || { open:{}, nested:{} };
        state.ui.open = state.ui.open || {};
        state.ui.open[s.key] = details.open;
        saveState();
      });

      details.innerHTML = `
        <summary>
          <div class="sumLeft">
            <span class="chev">‚ñ∂</span>
            <b>${s.title}</b>
          </div>
          <div class="sumRight">
            <span class="badge" id="pct_${s.key}">0%</span>
            <span class="badge" id="done_${s.key}">0/0</span>
            <span class="badge" id="bonus_${s.key}">Bonus: 0</span>
            <span class="badge" id="loot_${s.key}">Loot: 0</span>
          </div>
        </summary>
        <div class="sectionBody">
          <div class="sectionHint">${s.hint}</div>
          <div id="body_${s.key}"></div>
        </div>
      `;

      wrap.appendChild(details);
      const body = details.querySelector(`#body_${s.key}`);

      if(s.key === "lib"){
        body.appendChild(renderQiPratiqueNested());
        libertyStandalone.forEach(t => body.appendChild(taskRow(t, s.meta, "lib")));
        body.appendChild(renderSystemNested());
      } else if(s.key === "resp"){
        (s.tasks || []).forEach(t => body.appendChild(taskRow(t, s.meta, "resp")));
      } else if(s.key === "dev"){
        (s.tasks || []).forEach(t => body.appendChild(taskRow(t, s.meta, "dev")));
      } else if(s.key === "eff"){
        (s.tasks || []).forEach(t => body.appendChild(taskRow(t, s.meta, "eff")));
      } else {
        (s.tasks || []).forEach(t => body.appendChild(taskRow(t, s.meta)));
      }
    }
  }

  function renderQiPratiqueNested(){
    return nestedDetails(
      "qi",
      "üúÇ Qi Pratique",
      `<span class="badge" id="qiDone">0/0</span><span class="badge" id="qiPct">0%</span><span class="badge xpWarn" id="qiXp">0 XP</span>`,
      (body) => {
        body.appendChild(renderCultivationsNested());
        qiPractice
          .filter(t => t.id !== "qi_cultivations_group")
          .forEach(t => body.appendChild(taskRow(t, "Qi Pratique (compte dans Libert√©%).", "qi")));

        const note = document.createElement("div");
        note.className = "sectionHint";
        note.style.marginTop = "8px";
        note.textContent = "Bonus Qi Pratique: +15 XP si TOUT Qi Pratique est compl√©t√© (incluant toutes les Cultivations).";
        body.appendChild(note);
      },
      "qi"
    );
  }

  function renderCultivationsNested(){
    return nestedDetails(
      "cultivation",
      "üå± Cultivations (12 √©tapes) ‚Äî Total 30 XP",
      `<span class="badge" id="cultDone">0/12</span><span class="badge" id="cultPct">0%</span><span class="badge xpWarn" id="cultXp">0 XP</span>`,
      (body) => {
        cultivationTasks.forEach(t=>{
          body.appendChild(taskRow(t, "Sous-√©tape de Cultivations (compte dans Libert√©%).", "qi"));
        });
      },
      "qi"
    );
  }

  function renderSystemNested(){
    return nestedDetails(
      "system",
      "üß± Syst√®me / Organisation (4)",
      `<span class="badge" id="sysDone">0/4</span><span class="badge" id="sysPct">0%</span><span class="badge xpWarn" id="sysXp">0 XP</span>`,
      (body) => {
        systemTasks.forEach(t=>{
          body.appendChild(taskRow(t, "Syst√®me (compte dans Libert√©%).", "system"));
        });
        const note = document.createElement("div");
        note.className = "sectionHint";
        note.style.marginTop = "8px";
        note.textContent = "Bonus Syst√®me: +15 XP si les 4 √©l√©ments sont compl√©t√©s.";
        body.appendChild(note);
      },
      "system"
    );
  }

})();
</script>
</body>
</html>
